{# templates/main.cf.j2 #}
# ==========================================================================
# Postfix main configuration file
# GENERATED BY ANSIBLE - DO NOT EDIT MANUALLY
# Ansible Managed: {{ ansible_managed | comment }}
# ==========================================================================

# --- Core Identity ---
myhostname = {{ public_fqdn }}
myorigin = /etc/mailname
mydomain = {{ main_domain }}

# --- Address Handling ---
masquerade_domains = $myhostname
sender_canonical_maps = hash:/etc/postfix/sender_canonical
smtp_generic_maps = hash:/etc/postfix/generic

# --- Network Configuration ---
mydestination = $myhostname, localhost.{{ main_domain }}, localhost
inet_interfaces = all
mynetworks = 127.0.0.0/8 [::1]/128 {{ trusted_networks | default('10.0.0.0/8') }}
relayhost =

# --- EDEKA-Specific Fixes ---
smtputf8_enable = no                     
disable_smtputf8 = yes                  
smtp_always_send_esmtp = yes             
smtp_ignore_8bitmime_error = yes         

# --- Security Restrictions ---
smtpd_recipient_restrictions = 
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
    reject_non_fqdn_sender,
    reject_unknown_sender_domain

# --- TLS Configuration ---
smtpd_tls_cert_file = /etc/letsencrypt/live/{{ public_fqdn }}/fullchain.pem
smtpd_tls_key_file = /etc/letsencrypt/live/{{ public_fqdn }}/privkey.pem
smtpd_use_tls = yes
smtpd_tls_security_level = encrypt
smtp_tls_security_level = may            # More compatible outbound delivery

# Protocol/Cipher Settings
smtpd_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtpd_tls_ciphers = HIGH:!aNULL:!MD5:!RC4:!3DES
smtp_tls_protocols = !SSLv2, !SSLv3
smtp_tls_ciphers = HIGH:!aNULL:!MD5

# --- Performance & Logging ---
smtpd_tls_loglevel = 1
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtpd_tls_session_cache_timeout = 3600s

# --- Delivery Controls ---
# 100MB size limit
message_size_limit = 104857600          
smtpd_error_sleep_time = 10s
smtpd_soft_error_limit = 5
smtpd_hard_error_limit = 10

# --- Compatibility ---
compatibility_level = 3.6
append_dot_mydomain = no
biff = no